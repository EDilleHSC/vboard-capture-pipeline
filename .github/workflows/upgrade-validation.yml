name: Upgrade validation

on:
  push:
    branches:
      - 'upgrade/**'
  pull_request:
    branches:
      - 'main'
    # Only run when the head branch is an upgrade/* branch
  workflow_dispatch:
    inputs:
      target_docling_version:
        description: "Target Docling version (e.g. 0.9.0)"
        required: true
        type: string
      target_ref:
        description: "Branch or ref to validate (e.g. upgrade/docling-2026-01-08)"
        required: true
        type: string

jobs:
  validate-upgrade:
    name: Run upgrade validation (dry-run)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (manual dispatch target ref)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_ref }}
          fetch-depth: 0

      - name: Checkout (default)
        if: ${{ github.event_name != 'workflow_dispatch' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run upgrade validation script
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BRANCH_NAME="${{ github.event.inputs.target_ref }}"
            TARGET="${{ github.event.inputs.target_docling_version }}"
            echo "Manual dispatch detected — using target ref: $BRANCH_NAME and target Docling version: $TARGET"
          else
            BRANCH_NAME="${{ github.event.pull_request.head.ref || github.ref_name }}"
            TARGET="CI"
            echo "Non-manual run — using placeholder target Docling version: $TARGET"
          fi
          echo "Branch detected: $BRANCH_NAME"
          pwsh -NoProfile -NonInteractive -Command "& './scripts/upgrade_validation_check.ps1' -CreateBranchName \"$BRANCH_NAME\" -TargetDoclingVersion \"$TARGET\"" 2>&1 | tee upgrade_validation_output.txt

      - name: Upload validation output
        uses: actions/upload-artifact@v4
        with:
          name: upgrade-validation-output
          path: upgrade_validation_output.txt
